'use client';

import { useEffect, useState, Suspense, useRef, useCallback } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { usePosStore } from '@/store/pos-store';
import { formatMoney, getTaxName, getTaxRate } from '@/lib/currency';
import { useThemeStore, useLoadBranding, useThemeProvider } from '@/lib/use-theme';
import {
  Search, LogOut, Trash2, CreditCard, Banknote, X, ShoppingCart, ChefHat,
  User, Utensils, BarChart3, Package, FileText, Menu, Truck, Zap,
  Settings, Lock, ChevronRight, Bell, MoreHorizontal, Pause, Play,
  Tag, Calendar, Star, Users, QrCode, Home, Heart, Clock, Printer, Receipt,
  Send, ArrowRight, Smartphone, BookOpen, ChevronLeft, Check, UserSearch, Percent,
} from 'lucide-react';
import { usePermissions } from '@/lib/use-permissions';
import { printComanda, printPreBill, getPrintConfig } from '@/lib/print';
import { api } from '@/lib/api';
import SplitBillModal from '@/components/split-bill-modal';

const TSH_VERSION = '2.5.3';

const ICON_MAP: Record<string, any> = {
  Utensils, ChefHat, CreditCard, BarChart3, Package, FileText, User, Truck, Zap,
  Tag, Calendar, Star, Users, QrCode, Settings, ShoppingCart, Home,
};

function PosContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const store = usePosStore();
  const { hasAccess, visibleNavItems, role } = usePermissions();
  const branding = useThemeStore(s => s.branding);
  const { refreshBranding } = useLoadBranding();
  useThemeProvider();

  const [showPayment, setShowPayment] = useState(false);
  const [paymentMethod, setPaymentMethod] = useState<string | null>(null);
  const [cashAmount, setCashAmount] = useState('');
  const [paymentResult, setPaymentResult] = useState<any>(null);
  const [showCart, setShowCart] = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  const [showHeld, setShowHeld] = useState(false);
  const [showSplit, setShowSplit] = useState(false);
  const [sendingToKitchen, setSendingToKitchen] = useState(false);

  // Discount state
  const [showDiscount, setShowDiscount] = useState<{ scope: 'order' | 'item'; itemId?: string; itemName?: string; itemSubtotal?: number } | null>(null);
  const [discountType, setDiscountType] = useState<'percent' | 'fixed'>('percent');
  const [discountValue, setDiscountValue] = useState('');
  const [discountReason, setDiscountReason] = useState('');
  const [discountLoading, setDiscountLoading] = useState(false);

  // Credit payment state
  const [creditSearch, setCreditSearch] = useState('');
  const [creditResults, setCreditResults] = useState<any[]>([]);
  const [creditSearching, setCreditSearching] = useState(false);
  const [selectedCreditAccount, setSelectedCreditAccount] = useState<any>(null);

  const tableId = searchParams.get('tableId');
  const tableNumber = searchParams.get('tableNumber');
  const orderId = searchParams.get('orderId');

  // Refs
  const searchInputRef = useRef<HTMLInputElement>(null);
  const [showShortcuts, setShowShortcuts] = useState(false);

  useEffect(() => {
    store.restoreSession();
    if (!localStorage.getItem('pos_token')) { router.replace('/login'); return; }
    store.loadCategories(); store.loadProducts();
    if (orderId) store.loadOrder(orderId);
    store.loadHeldOrders();
    refreshBranding();

    // Init offline cache
    store.initOfflineCache();

    // Sync offline orders when coming back online
    const handleOnline = () => {
      console.log('[POS] Back online — syncing...');
      store.syncOffline();
      store.loadCategories();
      store.loadProducts();
    };
    window.addEventListener('online', handleOnline);
    return () => window.removeEventListener('online', handleOnline);
  }, []);

  // ── KEYBOARD SHORTCUTS ──
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      const tag = (e.target as HTMLElement)?.tagName;
      const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
      const order = usePosStore.getState().currentOrder;
      const items = order?.items?.filter((i: any) => !i.isVoid) || [];

      // F-keys work even in inputs
      if (e.key === 'F1') { e.preventDefault(); searchInputRef.current?.focus(); searchInputRef.current?.select(); return; }
      if (e.key === 'F2') { e.preventDefault(); if (items.length > 0) setShowPayment(true); return; }
      if (e.key === 'F3') { e.preventDefault(); store.clearOrder(); return; }
      if (e.key === 'F4') { e.preventDefault(); store.holdCurrentOrder(); return; }
      if (e.key === 'F5') { e.preventDefault(); setShowHeld(true); return; }
      if (e.key === 'F8') { e.preventDefault(); setShowShortcuts(s => !s); return; }
      if (e.key === 'F9') {
        e.preventDefault();
        const cfg = getPrintConfig();
        if (order) printComanda(order, cfg);
        return;
      }
      if (e.key === 'F10') {
        e.preventDefault();
        const cfg = getPrintConfig();
        if (order) printPreBill(order, cfg);
        return;
      }

      // Escape works in inputs and modals
      if (e.key === 'Escape') {
        if (showPayment) { setShowPayment(false); setPaymentMethod(null); setCashAmount(''); return; }
        if (showDiscount) { setShowDiscount(null); return; }
        if (showHeld) { setShowHeld(false); return; }
        if (showSplit) { setShowSplit(false); return; }
        if (showCart) { setShowCart(false); return; }
        if (showMenu) { setShowMenu(false); return; }
        if (showShortcuts) { setShowShortcuts(false); return; }
        if (document.activeElement === searchInputRef.current) { searchInputRef.current?.blur(); return; }
        return;
      }

      // Don't capture when typing in inputs
      if (isInput) return;

      // Quick payment shortcuts (only when payment modal is open)
      if (showPayment && !paymentMethod) {
        if (e.key === '1') { e.preventDefault(); setPaymentMethod('cash'); return; }
        if (e.key === '2') { e.preventDefault(); setPaymentMethod('card'); return; }
        if (e.key === '3') { e.preventDefault(); setPaymentMethod('transfer'); return; }
      }

      // +/- quantity on last item
      if ((e.key === '+' || e.key === '=') && order) {
        e.preventDefault();
        const lastItem = items[items.length - 1];
        if (lastItem) store.addItemToOrder(lastItem.productId || lastItem.product?.id);
        return;
      }

      // Send to kitchen: Ctrl+Enter
      if (e.key === 'Enter' && e.ctrlKey && order) {
        e.preventDefault();
        handleSendToKitchen();
        return;
      }
    };

    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  });

  const handleAddItem = async (product: any) => {
    if (!store.currentOrder) {
      const metadata = tableId ? { table_id: tableId, guest_count: 2 } : {};
      await store.createOrder(tableId ? 'dine_in' : 'sale', metadata);
      await new Promise(r => setTimeout(r, 200));
    }
    const order = usePosStore.getState().currentOrder;
    if (order) await store.addItemToOrder(product.id);
  };

  const handlePayment = async (method: string) => {
    if (!store.currentOrder) return;
    const total = parseFloat(store.currentOrder.total);
    const cash = method === 'cash' ? parseFloat(cashAmount) || total : undefined;
    const result = await store.processPayment(method, total, cash);
    if (result) {
      setPaymentResult(result);
      if (result.orderStatus === 'completed') {
        setTimeout(() => { setShowPayment(false); setPaymentResult(null); setCashAmount(''); setPaymentMethod(null); setShowCart(false); if (tableId) router.push('/tables'); }, 2500);
      }
    }
  };

  const handleCreditSearch = async (query: string) => {
    setCreditSearch(query);
    if (query.length < 2) { setCreditResults([]); return; }
    setCreditSearching(true);
    try {
      const res: any = await api.get(`/customers/search?q=${encodeURIComponent(query)}`);
      setCreditResults(Array.isArray(res) ? res : res.data || []);
    } catch { setCreditResults([]); }
    setCreditSearching(false);
  };

  const handleSelectCreditCustomer = async (customer: any) => {
    try {
      const account: any = await api.get(`/credit/customers/${customer.id}`);
      if (!account) {
        setSelectedCreditAccount({ customer, balance: 0, creditLimit: 0, noAccount: true });
        return;
      }
      // Normalize snake_case → camelCase from raw query
      setSelectedCreditAccount({
        ...account,
        creditLimit: parseFloat(account.credit_limit ?? account.creditLimit ?? 0),
        balance: parseFloat(account.balance ?? 0),
        customer,
      });
    } catch {
      setSelectedCreditAccount({ customer, balance: 0, creditLimit: 0, noAccount: true });
    }
  };

  const handleCreditPayment = async () => {
    if (!store.currentOrder || !selectedCreditAccount || selectedCreditAccount.noAccount) return;
    const total = parseFloat(store.currentOrder.total);
    const orderId = store.currentOrder.id;
    const orderNumber = store.currentOrder.orderNumber;
    // First process the payment as credit method
    const result = await store.processPayment('credit', total);
    if (result) {
      // Then record the charge on the credit account
      try {
        await api.post(`/credit/accounts/${selectedCreditAccount.id}/charge`, {
          orderId: orderId,
          amount: total,
          notes: `Orden ${orderNumber}`,
        });
      } catch (e: any) {
        console.error('Error recording credit charge:', e);
      }
      setPaymentResult(result);
      if (result.orderStatus === 'completed') {
        setTimeout(() => {
          setShowPayment(false); setPaymentResult(null); setPaymentMethod(null);
          setSelectedCreditAccount(null); setCreditSearch(''); setCreditResults([]);
          setShowCart(false); if (tableId) router.push('/tables');
        }, 2500);
      }
    }
  };

  const handleHoldOrder = () => {
    store.holdCurrentOrder();
    setShowCart(false);
    setShowPayment(false);
    setCashAmount('');
  };

  const handleSendToKitchen = async () => {
    if (!store.currentOrder) return;
    setSendingToKitchen(true);
    try {
      const result: any = await api.post(`/kitchen/fire/${store.currentOrder.id}`, {});
      if (result.sent > 0) {
        setKitchenToast(`Enviado a cocina: ${result.sent} items`);
        setTimeout(() => setKitchenToast(null), 3000);
      } else {
        setKitchenToast('Todos los items ya fueron enviados');
        setTimeout(() => setKitchenToast(null), 3000);
      }
    } catch (e: any) {
      setKitchenToast('Error al enviar a cocina');
      setTimeout(() => setKitchenToast(null), 3000);
    } finally { setSendingToKitchen(false); }
  };

  const [kitchenToast, setKitchenToast] = useState<string | null>(null);

  const handleApplyDiscount = async () => {
    if (!store.currentOrder || !discountValue) return;
    setDiscountLoading(true);
    try {
      const body = { type: discountType, value: parseFloat(discountValue), reason: discountReason || undefined };
      let updated: any;
      if (showDiscount?.scope === 'item' && showDiscount.itemId) {
        updated = await api.request(`/orders/${store.currentOrder.id}/items/${showDiscount.itemId}/discount`, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
        });
      } else {
        updated = await api.request(`/orders/${store.currentOrder.id}/discount`, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
        });
      }
      store.resumeOrder(updated);
      setShowDiscount(null); setDiscountValue(''); setDiscountReason(''); setDiscountType('percent');
    } catch (e: any) { alert(e.message); }
    setDiscountLoading(false);
  };

  const handleRemoveDiscount = async (scope: 'order' | 'item', itemId?: string) => {
    if (!store.currentOrder) return;
    try {
      const body = { type: 'fixed' as const, value: 0, reason: '' };
      let updated: any;
      if (scope === 'item' && itemId) {
        updated = await api.request(`/orders/${store.currentOrder.id}/items/${itemId}/discount`, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
        });
      } else {
        updated = await api.request(`/orders/${store.currentOrder.id}/discount`, {
          method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
        });
      }
      store.resumeOrder(updated);
    } catch (e: any) { alert(e.message); }
  };

  const handleResumeOrder = async (order: any) => {
    try {
      const fullOrder: any = await api.get(`/orders/${order.id}`);
      store.resumeOrder(fullOrder);
    } catch {
      store.resumeOrder(order);
    }
    setShowHeld(false);
  };

  const orderItems = store.currentOrder?.items?.filter((i: any) => !i.isVoid) || [];
  const orderTotal = store.currentOrder ? parseFloat(store.currentOrder.total) : 0;
  const taxName = getTaxName(); const taxPercent = Math.round(getTaxRate() * 100);
  const itemCount = orderItems.reduce((s: number, i: any) => s + parseFloat(i.quantity), 0);
  const heldCount = store.heldOrders.length;

  const getIcon = (name: string) => ICON_MAP[name] || User;

  const getHeldItemCount = (order: any) => {
    if (!order.items || !Array.isArray(order.items)) return 0;
    return order.items.filter((i: any) => i.status !== 'voided').length;
  };

  const getHeldTotal = (order: any) => {
    return parseFloat(order.total || '0');
  };

  const getTimeSince = (date: string) => {
    const mins = Math.floor((Date.now() - new Date(date).getTime()) / 60000);
    if (mins < 1) return 'ahora';
    if (mins < 60) return `${mins}m`;
    return `${Math.floor(mins / 60)}h ${mins % 60}m`;
  };

  // ── Order Panel (shared desktop/mobile) ──
  const OrderPanel = () => (
    <>
      <div className="flex items-center justify-between border-b px-4 py-3">
        <div className="flex items-center gap-2">
          <ShoppingCart size={18} className="text-blue-600" />
          <h2 className="font-semibold text-gray-900">{store.currentOrder ? store.currentOrder.orderNumber : 'Nueva Orden'}</h2>
          {tableNumber && <span className="rounded bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">Mesa {tableNumber}</span>}
        </div>
        <div className="flex items-center gap-1">
          {/* Print comanda */}
          {store.currentOrder && orderItems.length > 0 && (
            <button onClick={() => {
              const cfg = getPrintConfig({ tableNumber: tableNumber || undefined, serverName: store.user?.firstName });
              printComanda(store.currentOrder, cfg);
            }} className="rounded-lg p-1.5 text-blue-500 hover:bg-blue-50" title="Imprimir comanda">
              <ChefHat size={16} />
            </button>
          )}
          {/* Print pre-bill */}
          {store.currentOrder && orderItems.length > 0 && (
            <button onClick={() => {
              const cfg = getPrintConfig({ tableNumber: tableNumber || undefined, serverName: store.user?.firstName });
              printPreBill(store.currentOrder, cfg);
            }} className="rounded-lg p-1.5 text-green-500 hover:bg-green-50" title="Imprimir prefactura">
              <Receipt size={16} />
            </button>
          )}
          {/* Send to kitchen */}
          {store.currentOrder && orderItems.length > 0 && (
            <button onClick={handleSendToKitchen} disabled={sendingToKitchen}
              className="rounded-lg p-1.5 text-orange-500 hover:bg-orange-50 disabled:opacity-40" title="Enviar a cocina">
              <Send size={16} className={sendingToKitchen ? 'animate-pulse' : ''} />
            </button>
          )}
          {/* Hold button */}
          {store.currentOrder && orderItems.length > 0 && (
            <button onClick={handleHoldOrder} className="rounded-lg p-1.5 text-amber-500 hover:bg-amber-50" title="Poner en espera">
              <Pause size={16} />
            </button>
          )}
          {store.currentOrder && hasAccess('orders.cancel') && (
            <button onClick={() => store.cancelOrder()} className="rounded-lg p-1.5 text-red-500 hover:bg-red-50"><Trash2 size={16} /></button>
          )}
          <button onClick={() => setShowCart(false)} className="lg:hidden rounded-lg p-1.5 text-gray-400 hover:bg-gray-100"><X size={18} /></button>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto">
        {orderItems.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-gray-400 py-8">
            <ShoppingCart size={40} className="mb-2 opacity-30" /><p className="text-sm">Selecciona productos para comenzar</p>
          </div>
        ) : (
          <div className="divide-y">
            {orderItems.map((item: any) => {
              const itemDiscount = parseFloat(item.discountAmount || item.discount_amount || '0');
              return (
              <div key={item.id} className="flex items-center justify-between px-4 py-3">
                <div className="min-w-0 flex-1">
                  <p className="text-sm font-medium text-gray-900 truncate">{item.product?.name || item.productName}</p>
                  <p className="text-xs text-gray-500">{formatMoney(parseFloat(item.unitPrice))} x {parseFloat(item.quantity)}</p>
                  {item.notes && <p className="text-xs text-amber-600 italic">{item.notes}</p>}
                  {itemDiscount > 0 && (
                    <div className="flex items-center gap-1 mt-0.5">
                      <span className="text-[10px] font-semibold text-red-600 bg-red-50 rounded px-1.5 py-0.5">-{formatMoney(itemDiscount)} {item.discountReason || item.discount_reason || ''}</span>
                      {role !== 'waiter' && <button onClick={() => handleRemoveDiscount('item', item.id)} className="text-red-400 hover:text-red-600"><X size={10} /></button>}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-1.5">
                  <span className="text-sm font-semibold text-gray-900">{formatMoney(parseFloat(item.subtotal) - itemDiscount)}</span>
                  {role !== 'waiter' && !itemDiscount && (
                    <button onClick={() => setShowDiscount({ scope: 'item', itemId: item.id, itemName: item.product?.name || item.productName, itemSubtotal: parseFloat(item.subtotal) })}
                      className="rounded p-1 text-gray-300 hover:bg-green-50 hover:text-green-600" title="Descuento"><Percent size={12} /></button>
                  )}
                  {hasAccess('orders.void') && (
                    <button onClick={() => store.voidItem(item.id, 'Eliminado')} className="rounded p-1 text-gray-400 hover:bg-red-50 hover:text-red-500"><X size={14} /></button>
                  )}
                </div>
              </div>
              );
            })}
          </div>
        )}
      </div>
      {store.currentOrder && (
        <div className="border-t bg-gray-50/80 p-3 space-y-2">
          {/* ── Totals ── */}
          <div className="flex justify-between text-sm text-gray-500"><span>Subtotal</span><span>{formatMoney(parseFloat(store.currentOrder.subtotal) + parseFloat(store.currentOrder.discountAmount || store.currentOrder.discount_amount || '0'))}</span></div>
          {parseFloat(store.currentOrder.taxAmount || store.currentOrder.tax_amount || '0') > 0 && (
            <div className="flex justify-between text-sm text-gray-500"><span>{taxName} ({taxPercent}%)</span><span>{formatMoney(parseFloat(store.currentOrder.taxAmount || store.currentOrder.tax_amount || '0'))}</span></div>
          )}
          {(() => { const od = parseFloat(store.currentOrder.discountAmount || store.currentOrder.discount_amount || '0'); return od > 0 ? (
            <div className="flex justify-between text-sm text-red-600 font-medium">
              <span className="flex items-center gap-1">
                Descuento
                <span className="text-[10px] bg-red-50 rounded px-1">{store.currentOrder.discountReason || store.currentOrder.discount_reason || ''}</span>
                {role !== 'waiter' && <button onClick={() => handleRemoveDiscount('order')} className="text-red-400 hover:text-red-600"><X size={10} /></button>}
              </span>
              <span>-{formatMoney(od)}</span>
            </div>
          ) : null; })()}
          <div className="flex justify-between text-xl font-extrabold text-gray-900 pt-1 border-t border-gray-200"><span>Total</span><span>{formatMoney(orderTotal)}</span></div>
          {/* Discount button for cashier */}
          {role !== 'waiter' && orderItems.length > 0 && !parseFloat(store.currentOrder.discountAmount || store.currentOrder.discount_amount || '0') && (
            <button onClick={() => setShowDiscount({ scope: 'order' })}
              className="w-full flex items-center justify-center gap-1.5 rounded-lg border border-dashed border-green-300 py-1.5 text-xs font-semibold text-green-600 hover:bg-green-50 transition">
              <Percent size={12} /> Aplicar Descuento
            </button>
          )}

          {/* ═══════════ PAYMENT MODE ═══════════ */}
          {showPayment ? (
            <div className="space-y-3 pt-1">
              {/* ── Success state ── */}
              {paymentResult?.orderStatus === 'completed' ? (
                <div className="rounded-2xl bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 p-5 text-center">
                  <div className="mx-auto mb-2 flex h-12 w-12 items-center justify-center rounded-full bg-green-500">
                    <Check size={24} className="text-white" />
                  </div>
                  <p className="text-lg font-bold text-green-800">¡Pago completado!</p>
                  {paymentResult?.change > 0 && <p className="text-sm text-green-600 mt-1">Cambio: {formatMoney(paymentResult.change)}</p>}
                </div>
              ) : !paymentMethod ? (
                /* ── Payment method selection ── */
                <>
                  <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider">Método de pago</p>
                  <div className="grid grid-cols-2 gap-2">
                    {/* Cash */}
                    <button onClick={() => setPaymentMethod('cash')}
                      className="group flex flex-col items-center gap-1.5 rounded-2xl border-2 border-gray-200 bg-white p-3 transition hover:border-green-400 hover:bg-green-50 hover:shadow-md active:scale-[0.97]">
                      <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-green-100 text-green-600 group-hover:bg-green-500 group-hover:text-white transition">
                        <Banknote size={22} />
                      </div>
                      <span className="text-xs font-bold text-gray-700 group-hover:text-green-700">Efectivo</span>
                    </button>
                    {/* Card */}
                    <button onClick={() => handlePayment('credit_card')}
                      className="group flex flex-col items-center gap-1.5 rounded-2xl border-2 border-gray-200 bg-white p-3 transition hover:border-blue-400 hover:bg-blue-50 hover:shadow-md active:scale-[0.97]">
                      <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 text-blue-600 group-hover:bg-blue-500 group-hover:text-white transition">
                        <CreditCard size={22} />
                      </div>
                      <span className="text-xs font-bold text-gray-700 group-hover:text-blue-700">Tarjeta</span>
                    </button>
                    {/* Transfer */}
                    <button onClick={() => handlePayment('transfer')}
                      className="group flex flex-col items-center gap-1.5 rounded-2xl border-2 border-gray-200 bg-white p-3 transition hover:border-purple-400 hover:bg-purple-50 hover:shadow-md active:scale-[0.97]">
                      <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-purple-100 text-purple-600 group-hover:bg-purple-500 group-hover:text-white transition">
                        <Smartphone size={22} />
                      </div>
                      <span className="text-xs font-bold text-gray-700 group-hover:text-purple-700">Transferencia</span>
                    </button>
                    {/* Credit */}
                    <button onClick={() => setPaymentMethod('credit')}
                      className="group flex flex-col items-center gap-1.5 rounded-2xl border-2 border-gray-200 bg-white p-3 transition hover:border-amber-400 hover:bg-amber-50 hover:shadow-md active:scale-[0.97]">
                      <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-100 text-amber-600 group-hover:bg-amber-500 group-hover:text-white transition">
                        <BookOpen size={22} />
                      </div>
                      <span className="text-xs font-bold text-gray-700 group-hover:text-amber-700">Crédito</span>
                    </button>
                  </div>
                  <button onClick={() => { setShowPayment(false); setCashAmount(''); setPaymentMethod(null); }}
                    className="w-full rounded-xl py-2 text-sm font-medium text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition">
                    ← Volver
                  </button>
                </>
              ) : paymentMethod === 'cash' ? (
                /* ── Cash payment flow ── */
                <>
                  <div className="flex items-center gap-2 mb-1">
                    <button onClick={() => setPaymentMethod(null)} className="rounded-lg p-1 text-gray-400 hover:bg-gray-100"><ChevronLeft size={18} /></button>
                    <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-green-100"><Banknote size={16} className="text-green-600" /></div>
                    <span className="text-sm font-bold text-gray-700">Pago en Efectivo</span>
                  </div>
                  <div>
                    <label className="mb-1 block text-[10px] font-bold text-gray-400 uppercase tracking-wider">Efectivo recibido</label>
                    <input type="number" value={cashAmount} onChange={e => setCashAmount(e.target.value)} placeholder={orderTotal.toFixed(2)} autoFocus
                      className="w-full rounded-xl border-2 border-gray-200 bg-white px-4 py-3 text-xl font-bold text-gray-900 text-center focus:border-green-400 focus:outline-none focus:ring-4 focus:ring-green-400/10 transition" />
                  </div>
                  {/* Quick amounts */}
                  <div className="grid grid-cols-4 gap-1.5">
                    {[orderTotal, Math.ceil(orderTotal), Math.ceil(orderTotal/5)*5, Math.ceil(orderTotal/10)*10, Math.ceil(orderTotal/20)*20, 50, 100]
                      .filter((v,i,a) => v > 0 && a.indexOf(v)===i).slice(0,4).map(amount => (
                        <button key={amount} onClick={() => setCashAmount(amount.toFixed(2))}
                          className={`rounded-xl border-2 py-2 text-sm font-bold transition active:scale-95 ${
                            cashAmount === amount.toFixed(2) || cashAmount === amount.toString()
                              ? 'border-green-400 bg-green-50 text-green-700'
                              : 'border-gray-200 bg-white text-gray-600 hover:border-green-300'
                          }`}>${amount % 1 === 0 ? amount : amount.toFixed(2)}</button>
                      ))}
                  </div>
                  {/* Change preview */}
                  {cashAmount && parseFloat(cashAmount) > orderTotal && (
                    <div className="rounded-xl bg-green-50 border border-green-200 px-3 py-2 flex justify-between items-center">
                      <span className="text-xs font-medium text-green-600">Cambio</span>
                      <span className="text-lg font-extrabold text-green-700">{formatMoney(parseFloat(cashAmount) - orderTotal)}</span>
                    </div>
                  )}
                  <button onClick={() => handlePayment('cash')} disabled={!cashAmount || parseFloat(cashAmount) < orderTotal}
                    className="w-full flex items-center justify-center gap-2 rounded-2xl bg-green-600 py-3.5 font-bold text-white text-base hover:bg-green-700 transition disabled:opacity-40 active:scale-[0.98] shadow-lg shadow-green-600/20">
                    <Check size={20} /> Confirmar Pago
                  </button>
                </>
              ) : paymentMethod === 'credit' ? (
                /* ── Credit payment flow ── */
                <>
                  <div className="flex items-center gap-2 mb-1">
                    <button onClick={() => { setPaymentMethod(null); setSelectedCreditAccount(null); setCreditSearch(''); setCreditResults([]); }}
                      className="rounded-lg p-1 text-gray-400 hover:bg-gray-100"><ChevronLeft size={18} /></button>
                    <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-amber-100"><BookOpen size={16} className="text-amber-600" /></div>
                    <span className="text-sm font-bold text-gray-700">Pago a Crédito</span>
                  </div>

                  {!selectedCreditAccount ? (
                    /* Search customer */
                    <div className="space-y-2">
                      <div className="relative">
                        <UserSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
                        <input
                          type="text" value={creditSearch}
                          onChange={e => handleCreditSearch(e.target.value)}
                          placeholder="Buscar cliente por nombre o cédula..."
                          autoFocus
                          className="w-full rounded-xl border-2 border-gray-200 bg-white pl-10 pr-4 py-2.5 text-sm text-gray-900 focus:border-amber-400 focus:outline-none focus:ring-4 focus:ring-amber-400/10 transition"
                        />
                      </div>
                      {creditSearching && (
                        <div className="flex justify-center py-3"><div className="h-5 w-5 animate-spin rounded-full border-2 border-amber-400 border-t-transparent" /></div>
                      )}
                      {creditResults.length > 0 && (
                        <div className="rounded-xl border border-gray-200 bg-white overflow-hidden max-h-40 overflow-y-auto">
                          {creditResults.map((c: any) => (
                            <button key={c.id} onClick={() => handleSelectCreditCustomer(c)}
                              className="w-full text-left px-3 py-2.5 hover:bg-amber-50 transition border-b border-gray-100 last:border-0">
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="text-sm font-semibold text-gray-900">{c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim() || c.email}</p>
                                  <p className="text-[10px] text-gray-400">{c.tax_id || c.taxId || c.phone || c.email || ''}</p>
                                </div>
                                <ChevronRight size={14} className="text-gray-300" />
                              </div>
                            </button>
                          ))}
                        </div>
                      )}
                      {creditSearch.length >= 2 && !creditSearching && creditResults.length === 0 && (
                        <p className="text-center text-xs text-gray-400 py-2">No se encontraron clientes</p>
                      )}
                    </div>
                  ) : selectedCreditAccount.noAccount ? (
                    /* No credit account */
                    <div className="rounded-2xl bg-red-50 border border-red-200 p-4 text-center space-y-2">
                      <p className="text-sm font-bold text-red-700">{selectedCreditAccount.customer.name || `${selectedCreditAccount.customer.firstName || ''} ${selectedCreditAccount.customer.lastName || ''}`.trim()}</p>
                      <p className="text-xs text-red-500">Este cliente no tiene cuenta de crédito activa.</p>
                      <p className="text-[10px] text-red-400">Créala desde el módulo de Crédito.</p>
                      <button onClick={() => { setSelectedCreditAccount(null); setCreditSearch(''); }}
                        className="text-xs font-medium text-red-600 hover:underline mt-1">← Buscar otro cliente</button>
                    </div>
                  ) : (
                    /* Credit account found — confirm */
                    <div className="space-y-3">
                      <div className="rounded-2xl border-2 border-amber-200 bg-amber-50/50 p-3">
                        <div className="flex items-center justify-between mb-2">
                          <p className="text-sm font-bold text-gray-900">{selectedCreditAccount.customer.name || `${selectedCreditAccount.customer.firstName || ''} ${selectedCreditAccount.customer.lastName || ''}`.trim()}</p>
                          <button onClick={() => { setSelectedCreditAccount(null); setCreditSearch(''); }}
                            className="text-[10px] text-amber-600 hover:underline">Cambiar</button>
                        </div>
                        <div className="grid grid-cols-3 gap-2 text-center">
                          <div className="rounded-xl bg-white px-2 py-1.5 border border-amber-200">
                            <p className="text-[10px] text-gray-400 font-medium">Deuda</p>
                            <p className="text-sm font-bold text-gray-900">{formatMoney(selectedCreditAccount.balance)}</p>
                          </div>
                          <div className="rounded-xl bg-white px-2 py-1.5 border border-amber-200">
                            <p className="text-[10px] text-gray-400 font-medium">Límite</p>
                            <p className="text-sm font-bold text-gray-900">{formatMoney(selectedCreditAccount.creditLimit)}</p>
                          </div>
                          <div className="rounded-xl bg-white px-2 py-1.5 border border-green-200">
                            <p className="text-[10px] text-gray-400 font-medium">Disponible</p>
                            <p className="text-sm font-bold text-green-700">{formatMoney(Math.max(0, selectedCreditAccount.creditLimit - selectedCreditAccount.balance))}</p>
                          </div>
                        </div>
                        {selectedCreditAccount.balance + orderTotal > selectedCreditAccount.creditLimit && (
                          <div className="mt-2 rounded-lg bg-red-100 px-2 py-1.5 text-center">
                            <p className="text-[10px] font-bold text-red-600">⚠ Excede el límite — disponible: {formatMoney(Math.max(0, selectedCreditAccount.creditLimit - selectedCreditAccount.balance))}</p>
                          </div>
                        )}
                      </div>
                      <button onClick={handleCreditPayment}
                        disabled={selectedCreditAccount.balance + orderTotal > selectedCreditAccount.creditLimit}
                        className="w-full flex items-center justify-center gap-2 rounded-2xl bg-amber-500 py-3.5 font-bold text-white text-base hover:bg-amber-600 transition disabled:opacity-40 active:scale-[0.98] shadow-lg shadow-amber-500/20">
                        <BookOpen size={20} /> Cargar a Crédito — {formatMoney(orderTotal)}
                      </button>
                    </div>
                  )}
                </>
              ) : null}
            </div>
          ) : (
            /* ═══════════ ACTION BUTTONS (default view) ═══════════ */
            <div className="space-y-2 pt-1">
              {/* Main CTA — Cobrar (only for cashier/admin/owner) */}
              {role !== 'waiter' ? (
                <button onClick={() => setShowPayment(true)} disabled={orderItems.length===0}
                  className="w-full rounded-2xl py-4 font-extrabold text-white text-lg transition hover:opacity-90 disabled:opacity-30 active:scale-[0.98] shadow-lg"
                  style={{ backgroundColor: branding.accentColor, boxShadow: `0 8px 24px -4px ${branding.accentColor}40` }}>
                  Cobrar {formatMoney(orderTotal)}
                </button>
              ) : (
                <div className="rounded-2xl border-2 border-dashed border-gray-300 py-4 text-center">
                  <p className="text-sm font-semibold text-gray-400">Total: {formatMoney(orderTotal)}</p>
                  <p className="text-xs text-gray-400 mt-0.5">El cobro lo realiza el cajero</p>
                </div>
              )}

              {/* Secondary actions row */}
              <div className="grid grid-cols-2 gap-2">
                <button onClick={handleHoldOrder} disabled={orderItems.length===0}
                  className="flex items-center justify-center gap-2 rounded-xl bg-amber-50 border border-amber-200 py-2.5 text-sm font-bold text-amber-700 hover:bg-amber-100 transition disabled:opacity-30 active:scale-[0.97]">
                  <Pause size={16} /> En Espera
                </button>
                <button onClick={() => setShowSplit(true)} disabled={orderItems.length===0 || role === 'waiter'}
                  className={`flex items-center justify-center gap-2 rounded-xl bg-purple-50 border border-purple-200 py-2.5 text-sm font-bold text-purple-700 hover:bg-purple-100 transition disabled:opacity-30 active:scale-[0.97] ${role === 'waiter' ? 'hidden' : ''}`}>
                  <Users size={16} /> Dividir
                </button>
              </div>

              {/* Utility row */}
              <div className="grid grid-cols-3 gap-1.5">
                <button onClick={handleSendToKitchen} disabled={orderItems.length===0 || sendingToKitchen}
                  className="flex items-center justify-center gap-1 rounded-lg bg-orange-50 border border-orange-200 py-2 text-[11px] font-semibold text-orange-700 hover:bg-orange-100 transition disabled:opacity-30">
                  <Send size={13} /> {sendingToKitchen ? '...' : 'Cocina'}
                </button>
                <button onClick={() => {
                  const cfg = getPrintConfig({ tableNumber: tableNumber || undefined, serverName: store.user?.firstName });
                  printComanda(store.currentOrder, cfg);
                }} disabled={orderItems.length===0}
                  className="flex items-center justify-center gap-1 rounded-lg bg-gray-50 border border-gray-200 py-2 text-[11px] font-semibold text-gray-600 hover:bg-gray-100 transition disabled:opacity-30">
                  <Printer size={13} /> Comanda
                </button>
                <button onClick={() => {
                  const cfg = getPrintConfig({ tableNumber: tableNumber || undefined, serverName: store.user?.firstName });
                  printPreBill(store.currentOrder, cfg);
                }} disabled={orderItems.length===0}
                  className="flex items-center justify-center gap-1 rounded-lg bg-gray-50 border border-gray-200 py-2 text-[11px] font-semibold text-gray-600 hover:bg-gray-100 transition disabled:opacity-30">
                  <Receipt size={13} /> Prefactura
                </button>
              </div>
            </div>
          )}
        </div>
      )}
    </>
  );

  return (
    <div className="flex h-screen flex-col bg-gray-100">
      {/* ═══ HEADER ═══ */}
      <header className="flex h-12 shrink-0 items-center justify-between px-3 text-white"
        style={{ backgroundColor: branding.sidebarColor, color: branding.sidebarTextColor }}>

        <div className="flex items-center gap-2 min-w-0">
          <button onClick={() => setShowMenu(true)} className="rounded-lg p-1.5 hover:bg-white/10 transition" aria-label="Menú">
            <Menu size={20} />
          </button>
          <img src="/tsh-logo.png" alt="TSH" className="h-7 object-contain" />
          <span className="font-semibold text-sm truncate hidden sm:inline">{store.tenant?.name || 'TSH'}</span>
          {tableNumber && <span className="flex items-center gap-1 rounded-lg bg-amber-500 px-2 py-0.5 text-xs font-semibold shrink-0"><Utensils size={12} /> Mesa {tableNumber}</span>}
        </div>

        <div className="flex items-center gap-1">
          {/* Held orders badge */}
          <button onClick={() => setShowHeld(true)} className="relative rounded-lg p-2 hover:bg-white/10 transition" title="Órdenes en espera">
            <Pause size={18} />
            {heldCount > 0 && (
              <span className="absolute -right-0.5 -top-0.5 flex h-5 w-5 items-center justify-center rounded-full bg-amber-500 text-[10px] font-bold text-white">
                {heldCount}
              </span>
            )}
          </button>
          <button onClick={() => setShowCart(true)} className="lg:hidden relative rounded-lg p-2 hover:bg-white/10">
            <ShoppingCart size={20} />
            {itemCount > 0 && <span className="absolute -right-1 -top-1 flex h-5 w-5 items-center justify-center rounded-full bg-green-500 text-[10px] font-bold">{itemCount}</span>}
          </button>
          <div className="hidden lg:flex items-center gap-1 text-xs text-white/60">
            <span>{store.user?.firstName}</span>
          </div>
        </div>
      </header>

      {/* ═══ NAVIGATION DRAWER ═══ */}
      {showMenu && (
        <div className="fixed inset-0 z-50 flex">
          <div className="absolute inset-0 bg-black/40" onClick={() => setShowMenu(false)} />
          <div className="relative flex w-72 max-w-[80vw] flex-col bg-white shadow-2xl h-full overflow-hidden">
            <div className="shrink-0 flex items-center justify-between px-4 py-2.5 border-b" style={{ backgroundColor: branding.sidebarColor, color: branding.sidebarTextColor }}>
              <div className="flex items-center gap-2">
                <img src="/tsh-logo.png" alt="TSH" className="h-6 object-contain" />
                <span className="font-semibold text-sm">{store.tenant?.name || 'TSH Restaurantes'}</span>
              </div>
              <button onClick={() => setShowMenu(false)} className="rounded-lg p-1 hover:bg-white/10"><X size={18} /></button>
            </div>

            <div className="shrink-0 px-4 py-2 border-b bg-gray-50">
              <p className="text-sm font-bold text-gray-900">{store.user?.firstName} {store.user?.lastName}</p>
              <div className="flex items-center gap-2">
                <p className="text-xs text-gray-500 truncate">{store.user?.email}</p>
                <span className="shrink-0 rounded-full bg-blue-100 px-2 py-0.5 text-[10px] font-bold text-blue-700 uppercase">{role}</span>
              </div>
            </div>

            <nav className="flex-1 min-h-0 overflow-y-auto py-1 scrollbar-hide">
              {/* Principal */}
              <div className="px-3 pt-2.5 pb-1 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Principal</div>
              {[
                { path: '/dashboard', label: 'Dashboard', icon: BarChart3, accent: '#0ea5e9', roles: ['owner','admin'] },
                { path: '/pos', label: 'POS', icon: ShoppingCart, accent: '#2563eb', roles: ['owner','admin','cashier','waiter'] },
                { path: '/tables', label: 'Mesas', icon: Utensils, accent: '#10b981', roles: ['owner','admin','cashier','waiter'] },
                { path: '/kitchen', label: 'Cocina', icon: ChefHat, accent: '#f97316', roles: ['owner','admin','kitchen'] },
                { path: '/shifts', label: 'Caja', icon: CreditCard, accent: '#8b5cf6', roles: ['owner','admin','cashier'] },
              ].filter(i => i.roles.includes(role)).map(item => (
                <button key={item.path} onClick={() => { if (item.path === '/pos') { setShowMenu(false); } else { router.push(item.path); setShowMenu(false); } }}
                  className={`flex w-full items-center gap-3 px-4 py-2 text-sm transition ${item.path === '/pos' ? 'font-semibold' : 'text-gray-700 hover:bg-gray-50'}`}
                  style={item.path === '/pos' ? { backgroundColor: `${item.accent}12`, color: item.accent } : {}}>
                  <item.icon size={18} className={item.path === '/pos' ? '' : 'text-gray-400'} /> {item.label}
                </button>
              ))}

              {/* Ventas */}
              {['owner','admin','cashier'].includes(role) && (
                <>
                  <div className="px-3 pt-3 pb-1 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Ventas</div>
                  {[
                    { path: '/customers', label: 'Clientes', icon: User, roles: ['owner','admin','cashier'] },
                    { path: '/invoices', label: 'Facturas', icon: FileText, roles: ['owner','admin','cashier'] },
                    { path: '/promotions', label: 'Promos', icon: Tag, roles: ['owner','admin'] },
                    { path: '/reservations', label: 'Reservas', icon: Calendar, roles: ['owner','admin','cashier'] },
                    { path: '/delivery', label: 'Delivery', icon: Truck, roles: ['owner','admin','cashier'] },
                    { path: '/loyalty', label: 'Fidelidad', icon: Star, roles: ['owner','admin'] },
                    { path: '/credit', label: 'Crédito', icon: CreditCard, roles: ['owner','admin'] },
                  ].filter(i => i.roles.includes(role)).map(item => (
                    <button key={item.path} onClick={() => { router.push(item.path); setShowMenu(false); }}
                      className="flex w-full items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                      <item.icon size={18} className="text-gray-400" /> {item.label}
                    </button>
                  ))}
                </>
              )}

              {/* Operaciones */}
              {['owner','admin'].includes(role) && (
                <>
                  <div className="px-3 pt-3 pb-1 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Operaciones</div>
                  {[
                    { path: '/inventory', label: 'Inventario', icon: Package },
                    { path: '/products', label: 'Productos', icon: Tag },
                    { path: '/recipes', label: 'Recetas', icon: ChefHat },
                    { path: '/suppliers', label: 'Proveedores', icon: Truck },
                    { path: '/staff', label: 'Personal', icon: Users },
                  ].map(item => (
                    <button key={item.path} onClick={() => { router.push(item.path); setShowMenu(false); }}
                      className="flex w-full items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                      <item.icon size={18} className="text-gray-400" /> {item.label}
                    </button>
                  ))}
                </>
              )}

              {/* Administración */}
              {['owner','admin'].includes(role) && (
                <>
                  <div className="px-3 pt-3 pb-1 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Administración</div>
                  {[
                    { path: '/reports', label: 'Reportes', icon: BarChart3 },
                    { path: '/sri', label: 'SRI', icon: Zap },
                    { path: '/audit', label: 'Auditoría', icon: Lock },
                    { path: '/qr-menu', label: 'QR Menú', icon: QrCode },
                  ].map(item => (
                    <button key={item.path} onClick={() => { router.push(item.path); setShowMenu(false); }}
                      className="flex w-full items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                      <item.icon size={18} className="text-gray-400" /> {item.label}
                    </button>
                  ))}
                </>
              )}
            </nav>

            <div className="shrink-0 border-t py-1">
              {(role==='owner'||role==='admin') && (
                <button onClick={() => { router.push('/settings'); setShowMenu(false); }}
                  className="flex w-full items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                  <Settings size={18} className="text-gray-400" /> Configuración
                </button>
              )}
              <button onClick={() => { store.logout(); router.push('/login'); }}
                className="flex w-full items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                <LogOut size={18} /> Cerrar Sesión
              </button>
            </div>
            <div className="shrink-0 border-t px-4 py-2 bg-gray-50 text-center">
              <p className="text-[10px] text-gray-400">TSH Restaurantes v{TSH_VERSION}</p>
              <p className="text-[10px] text-gray-400">Desarrollado con <Heart size={8} className="inline text-red-400 fill-red-400" /> por <a href="https://twidoo.co" target="_blank" rel="noopener" className="text-blue-500 hover:underline">Twidoo</a></p>
            </div>
          </div>
        </div>
      )}

      {/* ═══ HELD ORDERS PANEL ═══ */}
      {showHeld && (
        <div className="fixed inset-0 z-50 flex">
          <div className="absolute inset-0 bg-black/40" onClick={() => setShowHeld(false)} />
          <div className="relative ml-auto flex w-full max-w-md flex-col bg-white shadow-2xl h-full overflow-hidden">
            <div className="shrink-0 flex items-center justify-between px-4 py-3 border-b bg-amber-50">
              <div className="flex items-center gap-2">
                <Pause size={18} className="text-amber-600" />
                <h2 className="font-bold text-gray-900">Órdenes en Espera</h2>
                {heldCount > 0 && <span className="rounded-full bg-amber-500 px-2 py-0.5 text-xs font-bold text-white">{heldCount}</span>}
              </div>
              <button onClick={() => setShowHeld(false)} className="rounded-lg p-1.5 hover:bg-amber-100"><X size={18} /></button>
            </div>
            <div className="flex-1 overflow-y-auto">
              {heldCount === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-gray-400 py-8">
                  <Pause size={40} className="mb-2 opacity-30" />
                  <p className="text-sm">No hay órdenes en espera</p>
                  <p className="text-xs mt-1">Usa el botón "En Espera" para guardar una orden</p>
                </div>
              ) : (
                <div className="divide-y">
                  {store.heldOrders.map((order: any) => {
                    const items = Array.isArray(order.items) ? order.items.filter((i: any) => !i.isVoid && i.status !== 'voided') : [];
                    const total = getHeldTotal(order);
                    const time = getTimeSince(order.created_at || order.createdAt || order.opened_at || order.openedAt);
                    return (
                      <button key={order.id} onClick={() => handleResumeOrder(order)}
                        className="w-full text-left px-4 py-3 hover:bg-amber-50 transition group">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-gray-900">{order.orderNumber || order.order_number}</span>
                            {(order.metadata?.table_id || order.metadata?.tableId) && (
                              <span className="rounded bg-amber-100 px-1.5 py-0.5 text-[10px] font-medium text-amber-700">
                                <Utensils size={10} className="inline mr-0.5" /> Mesa
                              </span>
                            )}
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="flex items-center gap-1 text-xs text-gray-400"><Clock size={12} /> {time}</span>
                            <Play size={16} className="text-green-500 opacity-0 group-hover:opacity-100 transition" />
                          </div>
                        </div>
                        <div className="mt-1 flex items-center justify-between">
                          <div className="text-xs text-gray-500">
                            {items.length > 0 ? (
                              items.slice(0, 3).map((i: any, idx: number) => (
                                <span key={idx}>{idx > 0 ? ', ' : ''}{i.productName || i.product?.name || 'Item'}</span>
                              ))
                            ) : (
                              <span>{getHeldItemCount(order)} items</span>
                            )}
                            {items.length > 3 && <span className="text-gray-400"> +{items.length - 3} más</span>}
                          </div>
                          <span className="text-sm font-bold text-gray-900">{formatMoney(total)}</span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
            {/* Start new order button */}
            <div className="shrink-0 border-t p-3">
              <button onClick={() => { store.clearOrder(); setShowHeld(false); }}
                className="w-full flex items-center justify-center gap-2 rounded-xl border-2 border-dashed border-gray-300 py-3 text-sm font-medium text-gray-500 hover:border-blue-400 hover:text-blue-600 transition">
                <ShoppingCart size={16} /> Nueva Orden
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ═══ MAIN CONTENT ═══ */}
      <div className="flex flex-1 overflow-hidden">
        <div className="flex flex-1 flex-col min-w-0">
          {/* Search */}
          <div className="border-b bg-white p-2 md:p-3">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
              <input ref={searchInputRef} type="text" placeholder="Buscar producto... (F1)" value={store.searchQuery} onChange={e => store.setSearchQuery(e.target.value)}
                className="w-full rounded-lg border border-gray-200 bg-gray-50 py-2 md:py-2.5 pl-10 pr-4 text-sm text-gray-900 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/20" />
            </div>
          </div>
          {/* Categories */}
          <div className="flex gap-2 overflow-x-auto border-b bg-white p-2 md:p-3 scrollbar-hide">
            <button onClick={() => store.setSelectedCategory(null)}
              className={`shrink-0 rounded-full px-3 md:px-4 py-1.5 text-xs md:text-sm font-medium transition ${!store.selectedCategory ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
              style={!store.selectedCategory ? { backgroundColor: branding.accentColor } : {}}>Todos</button>
            {store.categories.map((cat: any) => (
              <button key={cat.id} onClick={() => store.setSelectedCategory(cat.id)}
                className={`shrink-0 rounded-full px-3 md:px-4 py-1.5 text-xs md:text-sm font-medium transition ${store.selectedCategory===cat.id ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                style={store.selectedCategory===cat.id ? { backgroundColor: branding.accentColor } : {}}>{cat.name}</button>
            ))}
          </div>
          {/* Products grid */}
          <div className="flex-1 overflow-y-auto p-2 md:p-3">
            {store.loading ? (
              <div className="flex h-40 items-center justify-center"><div className="h-8 w-8 animate-spin rounded-full border-4" style={{ borderRightColor: branding.accentColor, borderBottomColor: branding.accentColor, borderLeftColor: branding.accentColor, borderTopColor: 'transparent' }} /></div>
            ) : (
              <div className="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 sm:gap-3">
                {store.products.map((product: any) => (
                  <button key={product.id} onClick={() => handleAddItem(product)} disabled={!product.isAvailable}
                    className={`group flex flex-col rounded-xl border bg-white p-2 sm:p-3 text-left transition hover:shadow-md ${!product.isAvailable ? 'opacity-40' : 'hover:border-blue-300'}`}>
                    {product.attributes?.kitchen_station && (
                      <span className={`mb-1 sm:mb-2 inline-flex w-fit items-center gap-1 rounded-full px-1.5 sm:px-2 py-0.5 text-[9px] sm:text-[10px] font-medium uppercase ${
                        product.attributes.kitchen_station==='grill' ? 'bg-orange-100 text-orange-700' : product.attributes.kitchen_station==='cold' ? 'bg-cyan-100 text-cyan-700' : product.attributes.kitchen_station==='bar' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'
                      }`}><ChefHat size={10} />{product.attributes.kitchen_station}</span>
                    )}
                    <h3 className="text-xs sm:text-sm font-medium text-gray-900 line-clamp-2">{product.name}</h3>
                    <div className="mt-auto pt-1 sm:pt-2"><span className="text-sm sm:text-lg font-bold" style={{ color: branding.accentColor }}>{formatMoney(parseFloat(product.price))}</span></div>
                  </button>
                ))}
              </div>
            )}
          </div>
          {/* Mobile order bar */}
          {store.currentOrder && (
            <div className="lg:hidden border-t bg-white px-3 py-2 flex items-center justify-between shadow-[0_-2px_10px_rgba(0,0,0,0.1)]">
              <div><p className="text-xs text-gray-500">{itemCount} items</p><p className="text-lg font-bold text-gray-900">{formatMoney(orderTotal)}</p></div>
              <button onClick={() => setShowCart(true)} className="rounded-xl px-6 py-2.5 font-semibold text-white hover:opacity-90" style={{ backgroundColor: branding.accentColor }}>Ver Orden</button>
            </div>
          )}
        </div>
        {/* Desktop order panel */}
        <div className="hidden lg:flex w-80 xl:w-96 flex-col border-l bg-white shrink-0"><OrderPanel /></div>
        {/* Mobile order panel overlay */}
        {showCart && (
          <div className="lg:hidden fixed inset-0 z-50 flex">
            <div className="absolute inset-0 bg-black/40" onClick={() => setShowCart(false)} />
            <div className="relative ml-auto flex w-full max-w-md flex-col bg-white shadow-2xl"><OrderPanel /></div>
          </div>
        )}
      </div>

      {/* ═══ FOOTER ═══ */}
      <div className="hidden lg:flex shrink-0 items-center justify-between px-4 py-1 bg-gray-100 border-t text-[10px] text-gray-400">
        <span>TSH Restaurantes v{TSH_VERSION}</span>
        <span>Desarrollado con <Heart size={8} className="inline text-red-400 fill-red-400 mx-0.5" /> por <a href="https://twidoo.co" target="_blank" rel="noopener" className="text-blue-500 hover:underline">Twidoo</a></span>
      </div>

      {/* Kitchen toast */}
      {kitchenToast && (
        <div className="fixed top-16 left-1/2 -translate-x-1/2 z-50 flex items-center gap-2 rounded-xl bg-orange-600 px-5 py-3 text-sm font-medium text-white shadow-2xl">
          <Send size={16} /> {kitchenToast}
        </div>
      )}

      {/* Split Bill Modal */}
      {showSplit && store.currentOrder && (
        <SplitBillModal
          order={store.currentOrder}
          branding={branding}
          onClose={() => setShowSplit(false)}
          onOrderCompleted={() => {
            setShowSplit(false);
            setShowPayment(false);
            setShowCart(false);
            store.clearOrder();
            if (tableId) router.push('/tables');
          }}
        />
      )}

      {/* Discount Modal */}
      {showDiscount && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50" onClick={() => setShowDiscount(null)}>
          <div className="w-full max-w-sm rounded-2xl bg-white p-6 shadow-2xl mx-4" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-2 mb-4">
              <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-green-100"><Percent size={20} className="text-green-600" /></div>
              <div>
                <h3 className="text-lg font-bold text-gray-900">
                  {showDiscount.scope === 'order' ? 'Descuento a la Orden' : 'Descuento al Item'}
                </h3>
                {showDiscount.itemName && <p className="text-xs text-gray-500">{showDiscount.itemName} — {formatMoney(showDiscount.itemSubtotal || 0)}</p>}
              </div>
            </div>

            {/* Type toggle */}
            <div className="flex rounded-xl bg-gray-100 p-1 mb-4">
              <button onClick={() => { setDiscountType('percent'); setDiscountValue(''); }}
                className={`flex-1 flex items-center justify-center gap-1.5 rounded-lg py-2 text-sm font-semibold transition ${discountType === 'percent' ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500'}`}>
                <Percent size={14} /> Porcentaje
              </button>
              <button onClick={() => { setDiscountType('fixed'); setDiscountValue(''); }}
                className={`flex-1 flex items-center justify-center gap-1.5 rounded-lg py-2 text-sm font-semibold transition ${discountType === 'fixed' ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500'}`}>
                $ Monto Fijo
              </button>
            </div>

            {/* Value input */}
            <div className="mb-3">
              <label className="mb-1 block text-sm font-medium text-gray-700">
                {discountType === 'percent' ? 'Porcentaje (%)' : 'Monto ($)'}
              </label>
              <input type="number" value={discountValue} onChange={e => setDiscountValue(e.target.value)}
                placeholder={discountType === 'percent' ? 'Ej: 10' : 'Ej: 5.00'}
                min="0" max={discountType === 'percent' ? '100' : undefined} step={discountType === 'percent' ? '1' : '0.01'}
                className="w-full rounded-xl border border-gray-300 px-4 py-3 text-xl font-bold text-center text-gray-900 focus:border-green-400 focus:outline-none" autoFocus />
            </div>

            {/* Quick percent buttons */}
            {discountType === 'percent' && (
              <div className="flex gap-2 mb-3">
                {[5, 10, 15, 20, 25, 50].map(p => (
                  <button key={p} onClick={() => setDiscountValue(String(p))}
                    className={`flex-1 rounded-lg py-2 text-xs font-bold transition ${discountValue === String(p) ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                    {p}%
                  </button>
                ))}
              </div>
            )}

            {/* Preview */}
            {discountValue && parseFloat(discountValue) > 0 && (() => {
              const base = showDiscount.scope === 'item' ? (showDiscount.itemSubtotal || 0) : (parseFloat(store.currentOrder?.total || '0') + parseFloat(store.currentOrder?.discountAmount || store.currentOrder?.discount_amount || '0'));
              const disc = discountType === 'percent' ? Math.round(base * parseFloat(discountValue) / 100 * 100) / 100 : parseFloat(discountValue);
              return (
                <div className="rounded-xl bg-green-50 border border-green-200 p-3 mb-3 text-center">
                  <p className="text-xs text-green-600">Descuento aplicado</p>
                  <p className="text-xl font-bold text-green-700">-{formatMoney(disc)}</p>
                  <p className="text-xs text-green-600 mt-0.5">Nuevo total: {formatMoney(Math.max(0, base - disc))}</p>
                </div>
              );
            })()}

            {/* Reason */}
            <div className="mb-4">
              <label className="mb-1 block text-xs font-medium text-gray-500">Razón (opcional)</label>
              <input type="text" value={discountReason} onChange={e => setDiscountReason(e.target.value)}
                placeholder="Ej: Cliente frecuente, promoción..."
                className="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:border-green-400 focus:outline-none" />
            </div>

            <div className="flex gap-3">
              <button onClick={() => { setShowDiscount(null); setDiscountValue(''); setDiscountReason(''); }}
                className="flex-1 rounded-xl border border-gray-300 py-2.5 font-medium text-gray-600 hover:bg-gray-50">Cancelar</button>
              <button onClick={handleApplyDiscount}
                disabled={discountLoading || !discountValue || parseFloat(discountValue) <= 0}
                className="flex-1 rounded-xl bg-green-600 py-2.5 font-semibold text-white hover:bg-green-700 disabled:opacity-40">
                {discountLoading ? 'Aplicando...' : 'Aplicar'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Keyboard Shortcuts Modal */}
      {showShortcuts && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setShowShortcuts(false)}>
          <div className="w-full max-w-md rounded-2xl bg-white shadow-2xl mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between px-6 py-4 border-b bg-gray-50">
              <h3 className="text-sm font-bold text-gray-900">Atajos de teclado</h3>
              <button onClick={() => setShowShortcuts(false)} className="rounded-lg p-1 text-gray-400 hover:bg-gray-200"><X size={16} /></button>
            </div>
            <div className="px-6 py-4 space-y-3 max-h-[60vh] overflow-y-auto">
              {[
                { key: 'F1', desc: 'Buscar producto' },
                { key: 'F2', desc: 'Cobrar orden' },
                { key: 'F3', desc: 'Nueva orden (limpiar)' },
                { key: 'F4', desc: 'Pausar orden (hold)' },
                { key: 'F5', desc: 'Ver órdenes en espera' },
                { key: 'F8', desc: 'Mostrar/ocultar atajos' },
                { key: 'F9', desc: 'Imprimir comanda' },
                { key: 'F10', desc: 'Imprimir pre-cuenta' },
                { key: 'Ctrl+↵', desc: 'Enviar a cocina' },
                { key: '+', desc: 'Repetir último item' },
                { key: 'Esc', desc: 'Cerrar modal / cancelar' },
                { key: '1 / 2 / 3', desc: 'Efectivo / Tarjeta / Transferencia (en cobro)' },
              ].map(s => (
                <div key={s.key} className="flex items-center justify-between">
                  <span className="text-sm text-gray-600">{s.desc}</span>
                  <kbd className="inline-flex items-center rounded-md border border-gray-300 bg-gray-100 px-2 py-0.5 text-xs font-mono font-semibold text-gray-700">{s.key}</kbd>
                </div>
              ))}
            </div>
            <div className="px-6 py-3 border-t bg-gray-50">
              <p className="text-[10px] text-gray-400 text-center">Presiona <kbd className="px-1 py-0.5 rounded bg-gray-200 text-[10px] font-mono">F8</kbd> en cualquier momento para ver estos atajos</p>
            </div>
          </div>
        </div>
      )}

      {/* Shortcuts hint badge (bottom-left, desktop only) */}
      <button
        onClick={() => setShowShortcuts(true)}
        className="hidden lg:flex fixed bottom-3 left-3 z-30 items-center gap-1.5 rounded-lg bg-gray-900/80 backdrop-blur px-2.5 py-1.5 text-[10px] text-white/70 hover:text-white hover:bg-gray-900 transition"
        title="Atajos de teclado (F8)"
      >
        <kbd className="rounded bg-white/20 px-1 py-0.5 text-[9px] font-mono">F8</kbd> Atajos
      </button>

      {/* Error toast */}
      {store.error && (
        <div className="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto flex items-center gap-2 rounded-lg bg-red-600 px-4 py-3 text-sm text-white shadow-lg z-50">
          <span>{store.error}</span>
          <button onClick={() => store.clearError()} className="ml-2 rounded p-1 hover:bg-red-700"><X size={14} /></button>
        </div>
      )}
    </div>
  );
}

export default function PosPage() {
  return (
    <Suspense fallback={<div className="flex h-screen items-center justify-center"><div className="h-8 w-8 animate-spin rounded-full border-4 border-blue-600 border-t-transparent" /></div>}>
      <PosContent />
    </Suspense>
  );
}
